language: node_js
node_js:
  - 'lts/*'

cache:
  yarn: true
  directories:
    - $HOME/.cache/pip
    - $HOME/.cache/proselint

addons:
  apt:
    packages:
      - python3-venv

env:
  global:
    secure: gjiWHIgNjLXuEFmLiepiOTHOuauHfeKHutrE0sBwFZUQzP9FoGTZzJub1z8/vm+hhygA+TZbB0iclygHyNrXCkZyNdnZXChXl4iPdYqY3OARPOAbQff16+/XSUDsZ/Ok1etdb3kKor1R4rBt/WywBvXmmdggumTA3yT5ExI+dyomdONo4yMUZ7g1la0ehMEzGqyVjt0nUW31PN3l6dI1qgigHCuotSrrpWP6fTXuUh5l6YA7KXb/V1hJxaGENLz1Cdfk0sF66e4KsV/DX6JZSqpvdqVB8OTPU+si511yJtGS8OeuLs4RqmXMLrY/ChCodlYnfCE+NleBFpUnCVqth/RDRh7LvplUJlpsXNcfyoA3mOFmZa0euOMCqJ3qwESz802Y9c5oN63hn2OUF/raFDc3SMMC86FFHxwyYjz5+yzXYupnFNj39NKdQ1v1KBbY8BD8UT8RU3mlu4/3LRz0tSamREHj3pGgBmvgUZfUE1dMngeaZjOmBaIZH8TnKQ75CvfnoT+LJnZo6g9g4uwz6jtaIziSMZ0OW/95nF8yx+xONbHEtt5ex5M09NOFsN2vB2bcUAgIjyGrmmNLQadwJyQv557IGPEE5CyGhJpXh9XZ+WMw2vO45MOw4sQPkARF6OJkMteqFc2NLXMOQJ07EScbgEKR/9VOcyxIk/7a7nc=

before_install:
  - python3 -m venv ~/.venv
  - . ~/.venv/bin/activate
  - pip install --quiet proselint
  - wget -qO - https://github.com/errata-ai/vale/releases/download/v1.7.1/vale_1.7.1_Linux_64-bit.tar.gz | tar -xzf - vale && chmod +x vale && sudo mv vale /usr/local/bin/

install:
  - cd ..
  - git clone --depth 1 https://github.com/api-platform/website.git
  - cd website
  - yarn install --silent
  - cd $TRAVIS_BUILD_DIR

before_script:
  - cp .proselintrc ~/.config/proselint/config

script:
  - proselint **/*.md || true
  - vale **/*.md || true
  - cd ../website
  - bin/retrieve-documentation
  - GATSBY_BRANCH_NAME=$TRAVIS_BRANCH yarn gatsby build
  # Preserve artifacts
  - cd $TRAVIS_BUILD_DIR
  - mv ../website/public public

deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  local_dir: public
  fqdn: api-platform.com
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^(master|2.5|2.4|2.3|2.2|2.1)$
